@prefix :      <http://debs2015.org/streams/> .
@prefix geo:   <http://www.opengis.net/ont/geosparql#> .
@prefix wgs84: <http://www.w3.org/2003/01/geo/wgs84_pos#> .
@prefix geof:  <http://www.opengis.net/def/geosparql/function/> .
@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .
@prefix time:  <http://www.w3.org/2006/time#> .
@prefix units: <http://unit#> .
@prefix debs:  <http://debs2015.org/onto#> .
@prefix sp:    <http://spinrdf.org/sp#> .
@prefix geodata: <http://linkedgeodata.org/ontology/addr%3A> .
@prefix rsp:   <http://w3id.org/rsp/spin#> .

[ a                    sp:Select ;
  sp:resultVariables   ( [ sp:varName  "time"^^xsd:string ] [ sp:varName
                    "district"^^xsd:string ] ) ;
  sp:where             ( [ a                   rsp:NamedWindow ;
                           sp:elements         ( [ sp:object     [ sp:varName  "lat"^^xsd:string ] ;
                                                   sp:predicate  debs:dropoff_latitude ;
                                                   sp:subject    [ sp:varName  "ride"^^xsd:string ]
                                                 ] [ sp:object     [ sp:varName  "lng"^^xsd:string ] ;
                                                     sp:predicate  debs:dropoff_longitude ;
                                                     sp:subject    [ sp:varName  "ride"^^xsd:string ]
                                                   ] [ sp:object     [ sp:varName  "time"^^xsd:string ] ;
                                                       sp:predicate  debs:dropoff_datetime ;
                                                       sp:subject    [ sp:varName  "ride"^^xsd:string ]
                                                     ] [ sp:object     [ sp:varName  "drop_hour"^^xsd:string ] ;
                                                         sp:predicate  time:hour ;
                                                         sp:subject    [ sp:varName  "time"^^xsd:string ]
                                                       ] [ sp:object     [ sp:varName  "dropGeom"^^xsd:string ] ;
                                                           sp:predicate  geo:hasGeometry ;
                                                           sp:subject    [ sp:varName  "feature"^^xsd:string ]
                                                         ] [ sp:object     [ sp:varName  "lat"^^xsd:string ] ;
                                                             sp:predicate  wgs84:lat ;
                                                             sp:subject    [ sp:varName  "feature"^^xsd:string ]
                                                           ] [ sp:object     [ sp:varName  "lng"^^xsd:string ] ;
                                                               sp:predicate  wgs84:lng ;
                                                               sp:subject    [ sp:varName  "feature"^^xsd:string ]
                                                             ] [ sp:object     [ sp:varName  "district"^^xsd:string ] ;
                                                                 sp:predicate  geodata:district ;
                                                                 sp:subject    [ sp:varName  "feature"^^xsd:string ]
                                                               ] [ a              sp:Filter ;
                                                                   sp:expression  [ a        sp:lt ;
                                                                                    sp:arg1  [ sp:varName  "drop_hour"^^xsd:string ] ;
                                                                                    sp:arg2  4
                                                                                  ]
                                                                 ] [ a              sp:Filter ;
                                                                     sp:expression  [ a        sp:lt ;
                                                                                      sp:arg1  22 ;
                                                                                      sp:arg2  [ sp:varName  "drop_hour"^^xsd:string ]
                                                                                    ]
                                                                   ] ) ;
                           rsp:windowNameNode  :wind
                         ] [ a                   rsp:NamedWindow ;
                             sp:elements         ( [ sp:object     [ sp:varName  "lat"^^xsd:string ] ;
                                                     sp:predicate  debs:pickup_latitude ;
                                                     sp:subject    [ sp:varName  "ride"^^xsd:string ]
                                                   ] [ sp:object     [ sp:varName  "lng"^^xsd:string ] ;
                                                       sp:predicate  debs:pickup_longitude ;
                                                       sp:subject    [ sp:varName  "ride"^^xsd:string ]
                                                     ] [ sp:object     [ sp:varName  "time"^^xsd:string ] ;
                                                         sp:predicate  debs:pickup_datetime ;
                                                         sp:subject    [ sp:varName  "ride"^^xsd:string ]
                                                       ] [ sp:object     [ sp:varName  "pick_hour"^^xsd:string ] ;
                                                           sp:predicate  time:hour ;
                                                           sp:subject    [ sp:varName  "time"^^xsd:string ]
                                                         ] [ sp:object     [ sp:varName  "pickGeom"^^xsd:string ] ;
                                                             sp:predicate  geo:hasGeometry ;
                                                             sp:subject    [ sp:varName  "place"^^xsd:string ]
                                                           ] [ sp:object     [ sp:varName  "lat"^^xsd:string ] ;
                                                               sp:predicate  wgs84:lat ;
                                                               sp:subject    [ sp:varName  "place"^^xsd:string ]
                                                             ] [ sp:object     [ sp:varName  "lng"^^xsd:string ] ;
                                                                 sp:predicate  wgs84:lng ;
                                                                 sp:subject    [ sp:varName  "place"^^xsd:string ]
                                                               ] [ sp:object     [ sp:varName  "district"^^xsd:string ] ;
                                                                   sp:predicate  geodata:district ;
                                                                   sp:subject    [ sp:varName  "place"^^xsd:string ]
                                                                 ] [ a              sp:Filter ;
                                                                     sp:expression  [ a        sp:lt ;
                                                                                      sp:arg1  [ sp:varName  "pick_hour"^^xsd:string ] ;
                                                                                      sp:arg2  4
                                                                                    ]
                                                                   ] [ a              sp:Filter ;
                                                                       sp:expression  [ a        sp:lt ;
                                                                                        sp:arg1  22 ;
                                                                                        sp:arg2  [ sp:varName  "pick_hour"^^xsd:string ]
                                                                                      ]
                                                                     ] ) ;
                             rsp:windowNameNode  :wind
                           ] [ a              sp:Filter ;
                               sp:expression  [ a        sp:gt ;
                                                sp:arg1  [ a        sp:sub ;
                                                           sp:arg1  [ sp:varName  "pick_hour"^^xsd:string ] ;
                                                           sp:arg2  [ sp:varName  "drop_hour"^^xsd:string ]
                                                         ] ;
                                                sp:arg2  1
                                              ]
                             ] [ a              sp:Filter ;
                                 sp:expression  [ a        geof:distance ;
                                                  sp:arg1  [ sp:varName  "dropGeom"^^xsd:string ] ;
                                                  sp:arg2  [ sp:varName  "pickGeom"^^xsd:string ] ;
                                                  sp:arg3  units:mile ;
                                                  sp:arg4  0.1
                                                ]
                               ] ) ;
  rsp:fromNamedWindow  [ a                rsp:LogicalWindow ;
                         rsp:logicalStep  "PT6H"^^xsd:duration ;
                         rsp:range        "PT6H"^^xsd:duration ;
                         rsp:streamIri    :rides ;
                         rsp:windowIri    :wind
                       ]
] .