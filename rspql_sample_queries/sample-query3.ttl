@prefix :      <http://debs2015.org/streams/> .
@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .
@prefix debs:  <http://debs2015.org/pred#> .
@prefix sp:    <http://spinrdf.org/sp#> .
@prefix rsp:   <http://w3id.org/rsp/spin#> .

[ a                    sp:Construct ;
  sp:templates         ( [ sp:object     [ sp:varName  "totalamount"^^xsd:string ] ;
                           sp:predicate  debs:profit ;
                           sp:subject    [ sp:varName  "location"^^xsd:string ]
                         ] ) ;
  sp:where             ( [ a         sp:SubQuery ;
                           sp:query  [ a                   sp:Select ;
                                       sp:groupBy          ( [ sp:varName  "location"^^xsd:string ] ) ;
                                       sp:limit            "3"^^xsd:long ;
                                       sp:orderBy          ( [ a              sp:Desc ;
                                                               sp:expression  [ sp:varName  "totalamount"^^xsd:string ]
                                                             ] ) ;
                                       sp:resultVariables  ( [ sp:expression  [ a              sp:Sum ;
                                                                                sp:expression  [ sp:varName  "amount"^^xsd:string ]
                                                                              ] ;
                                                               sp:varName     "totalamount"^^xsd:string
                                                             ] [ sp:varName  "location"^^xsd:string ] ) ;
                                       sp:where            ( [ a                   rsp:NamedWindow ;
                                                               sp:elements         ( [ sp:object     [ sp:varName  "location"^^xsd:string ] ;
                                                                                       sp:predicate  debs:pickup ;
                                                                                       sp:subject    [ sp:varName  "taxi"^^xsd:string ]
                                                                                     ] [ sp:object     [ sp:varName  "amount"^^xsd:string ] ;
                                                                                         sp:predicate  debs:amount ;
                                                                                         sp:subject    [ sp:varName  "location"^^xsd:string ]
                                                                                       ] ) ;
                                                               rsp:windowNameNode  :w
                                                             ] )
                                     ]
                         ] ) ;
  rsp:fromNamedWindow  [ a                rsp:LogicalWindow ;
                         rsp:logicalStep  "PT15M"^^xsd:duration ;
                         rsp:range        "PT30M"^^xsd:duration ;
                         rsp:streamIri    :s ;
                         rsp:windowIri    :w
                       ] ;
  rsp:registerAs       :query ;
  rsp:streamOperator   rsp:Istream
] .